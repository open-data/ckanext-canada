{% ckan_extends %}
{% import 'macros/canada_read.html' as cr %}

{% set pkg = c.pkg_dict %}
{% set client_lang = h.lang() %}
{% set wet_server = h.wet_url() %}

{% block subtitle %}{% endblock %}
{% block page_title %}{% endblock %}

{% block primary_content_inner %}
  {% block actions_content %}
    <ul class="nav nav-pills">
        {% if h.check_access('package_update', {'id':pkg.id }) %}
          {% block actions_content_inner %}
          {% link_for _('Edit'), controller='package', action='edit', id=pkg.name, class_='btn btn-primary', icon="pencil" %}
          {% link_for _('History'), controller='package', action='history', id=pkg.name, class_='btn btn-default' %}
          {{ h.follow_button('dataset', pkg.name) }}
          {% endblock %}
        {% endif %}
    </ul>
  {% endblock %}
  <div class="module">
    <section class="resources module-content indent-large">
      {% if pkg.state == "deleted" %}
      <div class="module-alert">
        <p>{{ _('This dataset has been deleted and is no longer accessible to non-admin users') }}.</p>
      </div>
      {% endif %}
    </section>

    {% block package_item_title %}
    <section class="module-content indent-large">

      <h1>{{ h.get_translated(pkg, 'title') or pkg.name }}
        {% if pkg.state.startswith('draft') %}
          [{{ _('Draft') }}]
        {% endif %}
      </h1>
      <div>
        {{ h.render_markdown(h.get_translated(pkg, 'notes')) }}
      </div>

      {% if 'fgp_viewer' in pkg.get('display_flags', []) %}
        <p><a href="/data/{{ h.lang() }}/ramp/ramp?keys={{ pkg.name }}" class="btn btn-primary btn-xs"><span class="fa fa-map-marker"></span> {{ _('View on Map') }}</a></p>    
      {% endif %}

    </section>
    {%- endblock -%}

    <section class="module-content indent-large">
      <div class="span-6 margin-top-medium">
        <div>
          <h4>{{_('Licence')}}: </h4>
        </div>
        <div>

        {% block package_item_license_inner %}
          {% if client_lang == 'fr' %}
            {% set license = h.get_license(pkg.license_id) %}
            <a href="{{ license.url_fra }}">{{ license.title_fra }}</a>
          {% else %}
            <a href="{{ pkg.license_url }}">{{ pkg.license_title }}</a>
          {% endif %}
        {% endblock %}

        </div>
        <div class="clear"></div>
      </div>
    </section>
    
    <section id="dataset-resources" class="module-content indent-large">
      <div class="span-6 margin-top-medium">
      {% if pkg.resources %}
        {% set nonapps = [] %}
        {% for resource in pkg.resources %}
          {% if not resource.related_type %}
            {% do nonapps.append(resource) %}
          {% endif %}
        {% endfor %}
        {% if nonapps %}
          {% snippet "package/snippets/resources_list.html", pkg=pkg, resources=nonapps %}
        {% endif %}
      {% endif %}
      </div>
    </section>

    <section class="indent-large">

      {% set apps = [] %}
      {% for resource in pkg.resources %}
        {% if resource.related_type %}
          {% do apps.append(resource) %}
        {% endif %}
      {% endfor %}

      {% if apps or pkg.collection == 'fgp' %}
      <h2>{{ _('Related Items') }}</h2>
        <ul class="list-bullet-none">
        {% if pkg.collection == 'fgp' %}
          <li><a href="http://csw.open.canada.ca/geonetwork/srv/csw?service=CSW&version=2.0.2&request=GetRecordById&outputSchema=csw:IsoRecord&ElementSetName=full&id={{ pkg.id }}">{{ _("HNAP ISO:19115 Metadata Record") }}</a></li>
        {% endif %}
        {% for resource in apps %}
          {% snippet 'package/snippets/app_item.html',
              pkg=pkg, res=resource, res_num=loop.index, client_lang=client_lang %}
        {% endfor %}
        </ul>
      {% endif %}
    </section>

{% block package_item_apps %}
  <div class="span-6 margin-top-medium">
    {% set apps = [] %}
    {% for resource in pkg.resources %}
      {% if resource.format == 'app' %}
        {% do apps.append(resource) %}
      {% endif %}
    {% endfor %}
  </div>

  {% if apps|length > 0 %}
    <div class="span-6 margin-top-medium">
      <h4>{{ _('Related Items') }}</h4>
      <ul class="list-unstyled">
      {% for resource in apps %}
        {% snippet 'package/snippets/app_item.html',
            pkg=pkg, res=resource, res_num=loop.index, client_lang=client_lang %}
      {% endfor %}
      </ul>
    </div>
    {% endif %}
{% endblock %}

{% block developer_tools %}
<div class="span-6 margin-top-medium">
  <h4>{{ _('Developer Tools') }}</h4>
    <ul class="list-unstyled">
      <li class="mrgn-bttm-md">{{ _('The information on this page (the publication metadata) is also available in JSON format') }} <br/>
      <a href="{{h.url_for_static('/', qualified=true)}}api/action/package_show?id={{pkg.id}}">{{ _('Link to JSON format') }}</a></li>
    </ul>
</div>
{% endblock developer_tools %}

{% block related_items %}
{#
<div class="span-6 margin-top-medium">
  <h4>{{ _('Related Items') }}</h4>
    <font color="red">
    <ul class="list-unstyled">
      <li class="mrgn-bttm-md"><a href="#">These related items</a></li>
      <li class="mrgn-bttm-md"><a href="#">are part of core</a></li>
      <li class="mrgn-bttm-md"><a href="#">CKAN 2.3 / multi-scheming</a></li>
      <li class="mrgn-bttm-md"><a href="#">work, not as part of</a></li>
      <li class="mrgn-bttm-md"><a href="#">Open Maps.</a></li>
      <li class="mrgn-bttm-md"><a href="#">(Except the) HNAP Source XML</a></li>
    </ul>
    </font>
</div>
#}
{% endblock related_items %}

{% block package_item_geo_preview %}
{% if pkg.geographic_region or pkg.spatial %}
<div class="span-6 margin-top-medium">
  <h4>{{ _('Geographic Information') }}</h4>
  {% if pkg.spatial %}
    {% set wkt = h.geojson_to_wkt(pkg.spatial) %}
    {% if wkt %}
      {% if h.get_map_type() == 'static' %}
        {% snippet 'snippets/geomap_static.html', gid=h.get_translated(pkg, 'title'), wkt=wkt %}
      {% else %}
        {% snippet 'snippets/geomap_dynamic.html', gid=h.get_translated(pkg, 'title'), wkt=wkt %}
      {% endif %}
    {% endif %}
  {% endif %}
  {% if pkg.geographic_region %}
    {% set schema = h.scheming_get_dataset_schema(pkg.type) %}
    {% set geo_region = h.scheming_field_by_name(schema.dataset_fields,
      'geographic_region') %}
    <div class="col-md-4">
      <h4>{{
      h.scheming_language_text(geo_region.label) }}: </h4>
    </div>
    <div class="col-md-8">
      {% snippet 'scheming/snippets/display_field.html',
        field=geo_region, data=pkg, entity_type='dataset', object_type=pkg.type %}
    </div>

  {% endif %}
</div>
{% endif %}
{% endblock package_item_geo_preview %}

{% block contact_information %}
  {% set info = h.contact_information(pkg.get('contact_information')) %}
  {% if info %}
    <div class="span-6 margin-top-medium">
      <h4>{{ _('Contact Information') }}</h4>
      {% if 'delivery_point' in info %}
        <p>{{ _('Delivery Point') }}: {{ info['delivery_point'] }}</p>
      {% endif %}
      {% if 'city' in info %}
        <p>{{ _('City') }}: {{ info['city'] }}</p>
      {% endif %}
      {% if 'administrative_area' in info %}
        <p>{{ _('Administrative Area') }}: {{ info['administrative_area'] }}</p>
      {% endif %}
      {% if 'postal_code' in info %}
        <p>{{ _('Postal Code') }}: {{ info['postal_code'] }}</p>
      {% endif %}
      {% if 'country' in info %}
        <p>{{ _('Country') }}: {{ info['country'] }}</p>
      {% endif %}
      {% if 'electronic_mail_address' in info %}
        <p>{{ _('Electronic Mail Address') }}:
        <a href="mailto:{{ info['electronic_mail_address'] }}"
          >{{ info['electronic_mail_address'] }}</a></p>
      {% endif %}
    </div>
  {% endif %}
{% endblock contact_information %}

{% block package_comments %}
{% include "package/comments.html" %}
{% endblock %}

  </div>
{% endblock primary_content_inner %}

{% block scripts %}
{{ super() }}
<!--[if gte IE 9 | !IE ]><!-->
<script src="{{ wet_server }}/geomapzoom.js" type="text/javascript"></script>
<!--<![endif]--><!--[if lt IE 9]>
<script src="{{ wet_server }}/geomapzoom.js"></script>
<![endif]-->
{% endblock %}

{% block package_license %}{% endblock %}
{% block package_item_notes %}{% endblock %}


