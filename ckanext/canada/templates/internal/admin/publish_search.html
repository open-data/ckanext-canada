{% extends 'admin/base.html' %}
{% import 'macros/form.html' as form %}

{% block primary_content_inner %}

{% resource 'js/check_all.js' %}

  <section id="search-results">
    <div class="module-poster">
      <form id="dataset-search" class="dataset-search form-inline mrgn-bttm-lg mrgn-tp-md" method="get" data-module="select-switch" role="search">
        <div id="search">
          <label for="q">{{_('Search Datasets')}}</label>
          <input type="text" class="search" style="width:100%;" name="q" id="q" value="{{ c.q }}" autocomplete="off" placeholder="{{ _('Search...') }}" size="45"/>
          {% block suggest_a_dataset_button %}{% endblock %}
        </div>

        <div class="pull-right">
          {{ h.snippet('snippets/sort_by.html', sort=c.sort_by_selected) }}
          <button type="submit" class="btn btn-large btn-primary" value="{{ _('Search') }}">{{ _('Submit') }}</button>
        </div>

        {% if c.fields -%}
          <span>
            {{ form.hidden_from_list(fields=c.fields) }}
          </span>
        {%- endif %}

        <div id="dataset-search-ext">{% block dataset_search_ext %}{% endblock %}</div>
      </form>
      <div class="{% if request.params and c.page.item_count == 0 -%}module-info module-simplify{%- endif -%}">
        <h3>{{_('Search Results:')}}</h3>
        <strong>
          {% snippet 'snippets/search_result_text.html', query=c.q, count=c.page.item_count, type='dataset' %}
        </strong>
        <div class="filter-list">
          {% block filter_list %}
          {% for field in c.fields_grouped %}
            {% set search_facets_items = c.search_facets.get(field)['items'] %}
            <span class="facet">{{ c.facet_titles.get(field) }}:</span>
            {% for value in c.fields_grouped[field] %}
              <span class="filtered pill background-accent facet-filter">
                {%- if c.translated_fields and c.translated_fields.has_key((field,value)) -%}
                  {{ c.translated_fields[(field,value)] }}
                {% elif field == 'subject' %}
                  {# since we separate subjects by two spaces instead of a pipe... #}
                  {{ cr.split_subject_field(value, h.lang()) }}
                {%- else -%}
                  {{ h.list_dict_filter(search_facets_items , 'name', 'display_name', value) }}
                {%- endif %}
                <a href="{{ h.remove_url_param(field, value=value) }}" class="remove" title="{{ _('Remove') }}"><span class="wb-icon-x"></span></a>
              </span>
            {% endfor %}
          {% endfor %}
          {% endblock %}
        </div>
        {% if request.params and c.page.item_count == 0 %}
          {% block try_another_search %}
          {% trans %}
            <p class="extra">Please try another search.</p>
          {% endtrans %}
          {% endblock %}
        {% endif %}
      </div>

      {% if c.query_error %}
        {% trans %}
          <p><strong>There was an error while searching.</strong> Please try again.</p>
        {% endtrans %}
      {% endif %}
      {{ h.snippet('admin/snippets/publish_package_list.html', packages=c.page.items) }}
    </div>

    {%- block pager -%}
      {{ c.page.pager(q=c.q) }}
    {%- endblock -%}
  </section>

  {%- block api_access_info -%}
    <!-- We want this block to be empty in the canada extension -->
  {%- endblock -%}
  
{% endblock %}

{% block extra_facets %}
  {# we want this to be empty. we don't want to show the publish/pending facet on the publish interface #}
{% endblock %}

{% block secondary_content %}
<div class="filters">
  <div>
    {% snippet 'snippets/facet_list.html',
      title=c.facet_titles['imso_approval'],
      name='ready_to_publish',
      scheming_choices=[
        {'value': 'true', 'label': _("IMSO Approved")},
        {'value': 'false', 'label': _("Not Approved")},
      ],
      extras=extras %}

    {% snippet 'snippets/dataset_facets.html',
      organization_facet=h.snippet(
        'snippets/facet_list.html', title=c.facet_titles['organization'],
        name='organization') %}
  </div>
</div>
{% endblock %}
